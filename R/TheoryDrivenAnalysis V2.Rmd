---
title: "Theory-driven meta-analysis TRACE"
author: "Milou Sep"
date: "4/21/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

## Analysis script for TRACE analyses (based on analyses script Valeria (meta behavior))
# Code largely based on // adapted from Bonapersona, V. (2019, May 20). The behavioral phenotype of early life adversity: a 3-level meta-analysis of rodent studies. Retrieved from osf.io/ra947


# Environment Preparation
```{r setup, include=FALSE}
rm(list = ls()) #clean environment
# libraries
library(dplyr) #general
library(ggplot2) #for graphs
library(metafor) #for meta-analysis
library(ggpubr) # To show multiple plots in 1 figure
library(flextable) # to create tables
library(officer)# to export tables to word
```

# Import dataset 
(processed with merge_datasets.rmd, recode_merged_data.rmd, add_effect_size_QA.rmd)
```{r}
data<-readRDS("processed_data/TRACEprepared.RData")
```

In check_comparision.rmd script frequency of observations in groups checked


## Split clinical and preclinical data
- Clinical and preclinical data are analyzed as two separate datasets 
- comparison "B" is excluded from clinical data as it does not contain PTSD-patients 

[A= non-exposed vs trauma-exposed PTSD (human); B=non-exposed vs trauma exposed no PTSD (human); C=trauma-exposed (noPTSD) vs trauma-exposed PTSD (human); D=non-exposed vs trauma-exposed (no PTSD checked) (animal); E=non-exposed vs trauma-exposed PTSD (animal); F=trauma-exposed (no ptsd) vs trauma-exposed PTSD (animal)]

```{r}
# Clinical data 
data %>% 
  filter(subject.cat =="Human") %>% 
  filter(comparison !="B") %>%
  droplevels() ->clinical

# Preclinical data 
data %>% 
  filter(subject.cat =="Animal") %>% 
  droplevels() ->preclinical
```


# Remove subgroups with < 4 papers from analyses (by removal of data)

## Clinical
```{r}
clinical %>% group_by(phase, valence) %>%
  summarize(papers=length(unique(PMID)), comparisons=length(each)) %>% data.frame()
```

```{r}
clinical %>% group_by(phase, valence) %>%
  summarize(papers=length(unique(PMID)), comparisons=length(each)) %>% 
  filter(papers <4) %>% 
  mutate(
    phase.valence.code = paste(phase, valence,sep=".")
  ) ->excluded.levels.human

excluded.levels.human
```

```{r}
clinical %>% 
  mutate(phase.valence.code = paste(phase, valence,sep=".")) ->clinical1
clinical1 %>% 
  filter(!(phase.valence.code %in% excluded.levels.human$phase.valence.code)) %>% droplevels() -> clinical.filtered
```

```{r}
# for checking (should be total numbers of papers above, so here 4)
clinical1 %>% filter((phase.valence.code %in% excluded.levels.human$phase.valence.code)) %>% distinct(PMID)
```



## Preclinical
```{r}
preclinical %>% group_by(phase, valence) %>%
  summarize(papers=length(unique(PMID)), comparisons=length(each))
```

```{r}
preclinical %>% group_by(phase, valence) %>%
  summarize(papers=length(unique(PMID)), comparisons=length(each)) %>% 
  filter(papers <4) %>% 
  mutate(
    phase.valence.code = paste(phase, valence,sep=".")
  ) ->excluded.levels.animal

excluded.levels.animal
```


> no exclusions needed in preclinial data (levels >=4 papers)



# **multilevel models**
code for posthoc Analyses + Plot:

```{r eval=FALSE, include=FALSE}
source("r/model_valence_phase.r")
```


## *Research Question 1: Learning and Memory of stressful and non-stressful information in PTSD patients*
```{r eval=FALSE, include=FALSE}
mod.H <- rma.mv(yi, vi,
                random = list(~1 | PMID, ~1 | idPTSD),  # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                mods   = ~phase:Valence_Grouped - 1,
                method = "REML",
                slab = clinical$reference,  # from old codes milou (change for author/year)
                data = clinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.H)



human<-TRACE_output(mod.H, title='Clinical Data', subtitle='PTSD patients' )  # volgorde contrasten klopt niet meer met code (emotional - stressvul)
human

# to save
jpeg(file="results/clinical.jpeg", height = 2000, width = 1500, res=300)
human[[2]]
dev.off()
```

```{r}
mod.H <- rma.mv(yi, vi,
                random = list(~1 | new.idPTSD , ~1 | PMID),  # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                # random = ~ 1 | new.idPTSD / each,  # identical results as row above  # https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/fitting-a-three-level-model.html
                # mods   = ~phase.valence - 1,
                 # mods = ~Valence_Grouped:phase-1, # all impaired  (NB E, F and T were grouped as emotional)
                 mods = ~valence:phase-1, # fear ext and fear memory impoved (trauma m NS), rest impaired
                method = "REML",
                slab = clinical$reference,  # from old codes milou (change for author/year)
                data = clinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.H)
```



```{r eval=FALSE, fig.height=40, fig.width=8, include=FALSE}
forest(mod.H, cex = .2)

# clinical %>% filter(yi > 4) %>% View()
# clinical %>% filter(measure.d == "EXT_%CS+/maxCS+Acq_EMG") %>% View()
```


## *Research Question 2: Learning and Memory of stressful and non-stressful information in animal models of PTSD*
```{r eval=FALSE, include=FALSE}
mod.A <- rma.mv(yi, vi,
                random = list(~1 | PMID, ~1 | idPTSD), # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                mods   = ~phase:Valence_Grouped - 1,  # NB only interaction term
                method = "REML",
                slab = preclinical$reference,  # from old codes milou (change for author/year)
                data = preclinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.A)

animal<-TRACE_output(mod.A, title='Preclinical Data', subtitle='animal models for PTSD')
animal

# to save
jpeg(file="results/preclinical.jpeg", height = 2000, width = 1500, res=300)
animal[[2]]
dev.off()
```


```{r eval=FALSE, include=FALSE}
mod.A <- rma.mv(yi, vi,
                random = list(~1 | new.idPTSD , ~1 | PMID), # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                # mods   = ~phase:Valence_Grouped - 1,  # NB only interaction term
                # mods   = ~phase.valence - 1, #NL & M impaired, rest improved
                mods = ~valence:phase-1, # identical resuls as above (so recoded var not needed)
                method = "REML",
                slab = preclinical$reference,  # from old codes milou (change for author/year)
                data = preclinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.A)
```

```{r eval=FALSE, fig.height=80, fig.width=8, include=FALSE}
forest(mod.A, cex = 0.4)
```




## **data presenation**
```{r}
# Show clincal & preclinical data in one figure.
plots<-ggarrange(
  human[[2]]
  #  + ylim(-7.5,3.5)  # If you want y-axis the same for clinical and preclinical
  + rremove("x.text") + rremove("x.axis") + rremove("x.ticks") + rremove("xlab")
  + rremove("y.axis") + rremove("y.ticks"),
  
  animal[[2]]
  # + ylim(-7.5,3.5)   # If you want y-axis the same for clinical and preclinical
  + rremove("x.text") + rremove("x.axis") + rremove("x.ticks") + rremove("xlab")
  + rremove("ylab") + rremove("y.axis") + rremove("y.ticks"),
  align = "v",
  legend="bottom",
  common.legend = T)

plots
```

## **safe results**
```{r}
# Save figure to jpeg.x
#ggsave(paste0("LearningMemoryPTSD_TRACE", date(),".jpg"), device="jpg", dpi = 500, height = 4, width = 6, limitsize = T )
ggsave(paste0("results/LearningMemoryPTSD_TRACE_NOinfluentials", date(),".jpg"), device="jpg", dpi = 300, height = 4, width = 6, limitsize = T )
#ggsave(paste0("LearningMemoryPTSD_TRACE_yshared", date(),".jpg"), device="jpg", dpi = 500, height = 4, width = 6, limitsize = T )
# ppt standard 4:3
```



# Sensitivity analysis

## study quality

### Clinical
```{r}
mod.H <- rma.mv(yi, vi,
                random = list(~1 | PMID, ~1 | idPTSD),  # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                mods   = ~phase:Valence_Grouped - 1,
                method = "REML",
                slab = clinical$reference,  # from old codes milou (change for author/year)
                data = clinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.H)
```

### Preclinical
```{r}
mod.A <- rma.mv(yi, vi,
                random = list(~1 | PMID, ~1 | idPTSD), # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                mods   = ~phase:Valence_Grouped - 1,  # NB only interaction term
                method = "REML",
                slab = preclinical$reference,  # from old codes milou (change for author/year)
                data = preclinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.A)
```



## Influential cases
phase x valence meta-regression

without cases that were identified as influential &outlier -> for sensitivity analysis


### clinical
```{r}
#clinical.inf<-influentials_valence_phase(clinical)
#saveRDS(clinical.inf, "processed_data/influentials.clinical.rds")
readRDS("processed_data/influentials.clinical.rds")->clinical.inf

# potential outlier and influential cases
clinical.inf[which(clinical.inf$outInf == 1),] %>% nrow()# 15 comparisons
clinical.inf[which(clinical.inf$outInf == 1),]%>% distinct(PMID) %>% nrow() # 7 papers

# # potential outliers
# clinical.inf[which(clinical.inf$potOut == 1),] %>% nrow()# 15 comparision 
# clinical.inf[which(clinical.inf$potOut == 1),]%>% distinct(PMID) %>% nrow()

# remove outliers
##  influential (Viechtbauer & Cheung) 
clinical.inf %>%
  filter(outInf != 1) %>%
  droplevels() -> clinical.noinfout
```


```{r}
mod.H.noinf <- rma.mv(yi, vi,
                      random = list(~1 | PMID, ~1 | idPTSD),  # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                      mods   = ~phase:Valence_Grouped - 1,
                      method = "REML",
                      slab = clinical.noinfout$reference,  # from old codes milou (change for author/year)
                      data = clinical.noinfout) # Similar effects with dat2 (trauma learning excluded)

summary(mod.H.noinf)

```


### preclinical
```{r}
source("r/influentials_valence_phase.r")
#preclinical.inf<-influentials_valence_phase(preclinical)
#saveRDS(preclinical.inf, "processed_data/influentials.preclinical.rds")
readRDS("processed_data/influentials.preclinical.rds")->preclinical.inf

# potential outlier and influential cases
preclinical.inf[which(preclinical.inf$outInf == 1),] %>% nrow() # 11 comparisons
preclinical.inf[which(preclinical.inf$outInf == 1),] %>% distinct(PMID) %>% nrow() # 4 papers

# preclinical.inf %>% filter(outInf == 1 & potOut==1) %>% nrow() # 11 comparisons
# preclinical.inf %>% filter(outInf == 1 & potOut==1) %>% distinct(PMID) %>% nrow() # 4 papers

# # potential outliers
# preclinical.inf[which(preclinical.inf$potOut == 1),] %>% nrow() # 28 comparisons
# preclinical.inf[which(preclinical.inf$potOut == 1),] %>% distinct(PMID) %>% nrow() # 14 papers
# preclinical.inf %>% filter(potOut!=1) #->data.sens

# remove outliers
##  influential (Viechtbauer & Cheung) 
# preclinical.inf %>%
#  filter(outInf != 1) %>%
# droplevels() -> preclinical.noinf # n=4 papers (11 comparison) excluded animal 

preclinical.inf %>%
  filter(outInf != 1) %>%  # potential outliers AND influential
  # filter(potOut!=1) %>%
  droplevels() -> preclinical.noinfnoout
```

```{r}
mod.A.noinf <- rma.mv(yi, vi,
                      random = list(~1 | PMID, ~1 | idPTSD), # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                      mods   = ~phase:Valence_Grouped - 1,  # NB only interaction term
                      method = "REML",
                      slab = preclinical.noinfnoout$reference,  # from old codes milou (change for author/year)
                      data = preclinical.noinfnoout) # Similar effects with dat2 (trauma learning excluded)
summary(mod.A.noinf)
```




