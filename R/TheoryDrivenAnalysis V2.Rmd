---
title: "Theory-driven meta-analysis TRACE"
author: "Milou Sep"
date: "4/21/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

## Analysis script for TRACE analyses (based on analyses script Valeria (meta behavior))
# Code largely based on // adapted from Bonapersona, V. (2019, May 20). The behavioral phenotype of early life adversity: a 3-level meta-analysis of rodent studies. Retrieved from osf.io/ra947


# Environment Preparation
```{r setup, include=FALSE}
rm(list = ls()) #clean environment
# libraries
library(dplyr) #general
library(ggplot2) #for graphs
library(metafor) #for meta-analysis
library(ggpubr) # To show multiple plots in 1 figure
library(flextable) # to create tables
library(officer)# to export tables to word
```

# Import dataset 
(processed with merge_datasets.rmd, recode_merged_data.rmd, add_effect_size_QA.rmd)
```{r}
data<-readRDS("processed_data/TRACEprepared.RData")
```

In check_comparison.rmd script frequency of observations in groups checked


## Split clinical and preclinical data
- Clinical and preclinical data are analyzed as two separate datasets 
- comparison "B" is excluded from clinical data as it does not contain PTSD-patients 

[A= non-exposed vs trauma-exposed PTSD (human); B=non-exposed vs trauma exposed no PTSD (human); C=trauma-exposed (noPTSD) vs trauma-exposed PTSD (human); D=non-exposed vs trauma-exposed (no PTSD checked) (animal); E=non-exposed vs trauma-exposed PTSD (animal); F=trauma-exposed (no ptsd) vs trauma-exposed PTSD (animal)]

```{r}
# Clinical data 
data %>% 
  filter(subject.cat =="Human") %>% 
  filter(comparison !="B") %>%
  droplevels() ->clinical

# Preclinical data 
data %>% 
  filter(subject.cat =="Animal") %>% 
  droplevels() ->preclinical
```


# Remove subgroups with < 4 papers from analyses (by removal of data)

## Clinical
```{r}
clinical %>% group_by(phase, valence) %>%
  summarize(papers=length(unique(PMID)), comparisons=length(each)) %>% data.frame()
```

```{r}
clinical %>% group_by(phase, valence) %>%
  summarize(papers=length(unique(PMID)), comparisons=length(each)) %>% 
  filter(papers <4) %>% 
  mutate(
    phase.valence.code = paste(phase, valence,sep=".")
  ) ->excluded.levels.human

excluded.levels.human
```

```{r}
clinical %>% 
  mutate(phase.valence.code = paste(phase, valence,sep=".")) ->clinical1
clinical1 %>% 
  filter(!(phase.valence.code %in% excluded.levels.human$phase.valence.code)) %>% droplevels() -> clinical.filtered
```

```{r}
# for checking (should be total numbers of papers above, so here 4)
clinical1 %>% filter((phase.valence.code %in% excluded.levels.human$phase.valence.code)) %>% distinct(PMID)
```



## Preclinical
```{r}
preclinical %>% group_by(phase, valence) %>%
  summarize(papers=length(unique(PMID)), comparisons=length(each))
```

```{r}
preclinical %>% group_by(phase, valence) %>%
  summarize(papers=length(unique(PMID)), comparisons=length(each)) %>% 
  filter(papers <4) %>% 
  mutate(
    phase.valence.code = paste(phase, valence,sep=".")
  ) ->excluded.levels.animal

excluded.levels.animal
```


> no exclusions needed in preclinial data (levels >=4 papers)



# **multilevel models**
code for posthoc Analyses + Plot:

```{r eval=FALSE, include=FALSE}
source("r/model_valence_phase.r")
```


## *Research Question 1: Learning and Memory of stressful and non-stressful information in PTSD patients*
```{r eval=FALSE, include=FALSE}
mod.H <- rma.mv(yi, vi,
                random = list(~1 | PMID, ~1 | idPTSD),  # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                mods   = ~phase:Valence_Grouped - 1,
                method = "REML",
                slab = clinical$reference,  # from old codes milou (change for author/year)
                data = clinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.H)



human<-TRACE_output(mod.H, title='Clinical Data', subtitle='PTSD patients' )  # volgorde contrasten klopt niet meer met code (emotional - stressvul)
human

# to save
jpeg(file="results/clinical.jpeg", height = 2000, width = 1500, res=300)
human[[2]]
dev.off()
```

```{r}
mod.H.total <- rma.mv(yi, vi,
                      random = list(~1 | new.idPTSD , ~1 | PMID),  # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                      # random = ~ 1 | new.idPTSD / each,  # identical results as row above  # https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/fitting-a-three-level-model.html
                      # mods   = ~phase.valence - 1,
                      # mods = ~Valence_Grouped:phase-1, # all impaired  (NB E, F and T were grouped as emotional)
                      mods = ~valence:phase-1, # fear ext and fear memory impoved (trauma m NS), rest impaired
                      method = "REML",
                      slab = clinical$reference,  # from old codes milou (change for author/year)
                      data = clinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.H.total)
```


```{r}
mod.H <- rma.mv(yi, vi,
                random = list(~1 | new.idPTSD , ~1 | PMID),  # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                # random = ~ 1 | new.idPTSD / each,  # identical results as row above  # https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/fitting-a-three-level-model.html
                # mods   = ~phase.valence - 1,
                # mods = ~Valence_Grouped:phase-1, # all impaired  (NB E, F and T were grouped as emotional)
                mods = ~valence:phase-1, # fear ext and fear memory impoved (trauma m NS), rest impaired
                method = "REML",
                slab = clinical.filtered$reference,  # from old codes milou (change for author/year)
                data = clinical.filtered) # Similar effects with dat2 (trauma learning excluded)
summary(mod.H)
```

add contrasts
```{r}
TRACE_clinical_valence_phase <- function(model, title, subtitle){
  
  ##RQ 1: "Main effects PTSD on Learning and memory?
  Learning <- anova(model, L = c(0, .5, .5, 0, 0))
  Memory <- anova(model, L = c(0,0,0, .5, .5))
  Extinction<-anova(model, L=c(1,0,0,0,0))
  
  
  # some info: Test linear combinations (http://www.metafor-project.org/doku.php/tips:testing_factors_lincoms)
  # http://www.metafor-project.org/doku.php/tips:multiple_factors_interactions
  
  # RQ2 "Main effects of PTSD on neutral / emotional   # 20.4.21 now the other way around (with label emotional ipv stresvull)
  Neutral <- anova(model, L = c(0,0,.5,0,.5))
  Emotional <- anova(model, L = c(1/3, 1/3, 0, 1/3,0))
  
  ## posthoc RQ2. is learning or memory most effected by valence? (Posthoc)
  phase.neutral <- anova(model, L = c(0,0,-1,0,1)) 
  phase.emotional <- anova(model, L = c(0, -1,0, 1,0)) # learning -
  
  # Posthoc RQ2 influence of valence on learning or memory
  valence.learning <-anova(model, L = c(0, 1, -1, 0,0)) # neutral = -
  valence.memory <- anova(model, L = c(0,0,0, 1, -1))
  
  
  #RQ3: neutral and stressful learning and memory in  ## PRECIES hetzelfde als de values in ht model! -> so below values from e.g. model$se used
  extinction <- anova(model, L = c(1,0, 0, 0,0))
  fearLearning <- anova(model, L = c(0,1, 0, 0,0))
  neutralLearning <- anova(model, L = c(0,0, 1, 0,0))
  emotionalMemory <- anova(model, L = c(0,0, 0, 1,0))
  neutralMemory <- anova(model, L = c(0,0, 0, 0, 1))
  
  
  
  ##Summary results organized in table
  #resultMain <- data.frame(matrix(data = NA, nrow = 17, ncol = 8))
  # resultMain <- data.frame(matrix(data = NA, nrow = 12, ncol = 8)) #v1
  resultMain <- data.frame(matrix(data = NA, nrow = 13, ncol = 8)) #V new
  
  colnames(resultMain) <- c("test", "ci.lb", "ci.ub", 
                            "effectsize", "se", "Zvalue",  
                            "Pvalue", "Pvalue_bonfCorr")
  
  resultMain[,1] <- c("Learning (neutral + emotional)", "Memory (neutral + emotional)", 
                      "Neutral (learning + memory)", "Emotional (learning + memory + extintion)",
                      "phase.neutral: learning vs memory (neutral)", "phase.emotional: learning vs memory (emotional)",
                      "valence.learning: neutral vs emotional (learning)", "valence.memory: neutral vs emotional (memory)",
                      "neutral Learning", "neutral Memory", "fear Learning", "emotional Memory", "fear Extinction")
  
  resultMain[,4] <- round(c(Learning$Lb, Memory$Lb, 
                            Neutral$Lb, Emotional$Lb,
                            phase.neutral$Lb, phase.emotional$Lb,
                            valence.learning$Lb, valence.memory$Lb,
                            # model$beta
                            neutralLearning$Lb, neutralMemory$Lb,
                            fearLearning$Lb, emotionalMemory$Lb,
                            extinction$Lb
  ), digits = 4) #effect size
  
  resultMain[,5] <- round(c(Learning$se, Memory$se, 
                            
                            Neutral$se, Emotional$se,
                            phase.neutral$se, phase.emotional$se,
                            valence.learning$se, valence.memory$se,
                            # model$beta
                            neutralLearning$se, neutralMemory$se,
                            fearLearning$se, emotionalMemory$se,
                            extinction$se
                            
                            # Neutral$se, Stressful$se,
                            # phase.neutral$se, phase.stressful$se,
                            # valence.learning$se, valence.memory$se,
                            # # nLearning$se, nMemory$se, sLearning$se, sMemory$se, # idem as model$se
                            # model$se
  ), digits = 4) #se
  
  resultMain[,6] <- round(c(Learning$zval, Memory$zval, 
                            
                            Neutral$zval, Emotional$zval,
                            phase.neutral$zval, phase.emotional$zval,
                            valence.learning$zval, valence.memory$zval,
                            # model$beta
                            neutralLearning$zval, neutralMemory$zval,
                            fearLearning$zval, emotionalMemory$zval,
                            extinction$zval
                            
                            # Neutral$zval, Stressful$zval,
                            # phase.neutral$zval, phase.stressful$zval,
                            # valence.learning$zval, valence.memory$zval,
                            # model$zval
  ), digits = 4)  #zvalues
  
  resultMain[,7] <- round(c(Learning$pval, Memory$pval, 
                            
                            
                            Neutral$pval, Emotional$pval,
                            phase.neutral$pval, phase.emotional$pval,
                            valence.learning$pval, valence.memory$pval,
                            # model$beta
                            neutralLearning$pval, neutralMemory$pval,
                            fearLearning$pval, emotionalMemory$pval,
                            extinction$pval
                            
                            # Neutral$pval, Stressful$pval,
                            # phase.neutral$pval, phase.stressful$pval,
                            # valence.learning$pval, valence.memory$pval,
                            # model$pval
  ), digits = 4)  #pvalues
  
  resultMain[,2] <- round(resultMain[,4] - (resultMain[,5] * 1.96), digits = 4) #CI lower 
  resultMain[,3] <- round(resultMain[,4] + (resultMain[,5] * 1.96), digits = 4) #CI upper
  
  # 16.4.21 was 2 changed to 12, as the number of comparisons (within one hypothesis).. NB same resutls for correction by 2 or 12 (for human & animal)
  # # Beter checken! (not needed for now? only report model effect ("different from 0"), not yet the difference between each other.))
  # resultMain[,8] <- round(c(p.adjust(resultMain[ 1,7], method = "bonferroni", n = 12), # learning (I think 2, as each estimate is used once for a phase contrast (L, M) and once for a valence contrast (S,N))
  #                           p.adjust(resultMain[ 2,7], method = "bonferroni", n = 12), # memory
  #                           p.adjust(resultMain[ 3,7], method = "bonferroni", n = 12), # neutral
  #                           p.adjust(resultMain[ 4,7], method = "bonferroni", n = 12), # stressful
  #                           p.adjust(resultMain[ 5,7], method = "bonferroni", n = 12), # l vs m (neutral) (also 2 for all posthocs?)
  #                           p.adjust(resultMain[ 6,7], method = "bonferroni", n = 12), # l vs m (stress)
  #                           p.adjust(resultMain[ 7,7], method = "bonferroni", n = 12), # neutral vs stres (learning)
  #                           p.adjust(resultMain[ 8,7], method = "bonferroni", n = 12), # neutral vs stres (memory)
  #                           
  #                           p.adjust(resultMain[ 9,7], method = "bonferroni", n = 12), 
  #                           p.adjust(resultMain[ 10,7], method = "bonferroni", n = 12), 
  #                           p.adjust(resultMain[ 11,7], method = "bonferroni", n = 12), 
  #                           p.adjust(resultMain[ 12,7], method = "bonferroni", n = 12), 
  #                           p.adjust(resultMain[ 13,7], method = "bonferroni", n = 13)), 
  #                           # resultMain[9,7],
  #                           # resultMain[10,7],
  #                           # resultMain[11,7],
  #                           # resultMain[12,7])
  #                          digits = 4) #pvalue bonf correction
  
  resultMain[,8] <- round(c(p.adjust(resultMain[,7], method = "bonferroni", n = 13)),
                          digits = 4) #pvalue bonf correction
  
  
  # resultMain[,1] <- c("Learning (neutral + emotional)", "Memory (neutral + emotional)", 
  #                   "Neutral (learning + memory)", "Emotional (learning + memory + extintion)",
  #                   "phase.neutral: learning vs memory (neutral)", "phase.emotional: learning vs memory (emotional)",
  #                   "valence.learning: neutral vs emotional (learning)", "valence.memory: neutral vs emotional (memory)",
  #                   "neutral Learning", "neutral Memory", "fear Learning", "emotional Memory", "fear Extinction")
  # 
  
  
  plot_data<-resultMain %>% filter(test %in% c( "neutral Learning", "neutral Memory", "fear Learning", "emotional Memory", "fear Extinction"))
  plot_data %>% mutate(
    valence = ifelse(test %in% c("neutral Learning", "neutral Memory"), "Neutral", "Emotional"),
    phase = case_when(
      test %in% c( "neutral Learning", "fear Learning") ~ "Learning", 
      test %in% c( "neutral Memory", "emotional Memory") ~ "Memory", 
      test == "fear Extinction" ~ "Extinction"
    )#,
    # phase = factor(phase, levels = c("Learning", "Memory", "Extinction"))  # dan error with plot
  ) ->plot_data_coded
  
  # plot_data$valence <- 
  # plot_data$phase <- ifelse(plot_data$test %in% c( "neutral Learning", "fear Learning",), "Learning", 
  #                           
  #                           "Memory")
  
  # signal sig. categories. Add index for p-values smaller than 0.05
  plot_data_coded$sig<- ifelse(plot_data_coded$Pvalue_bonfCorr  <0.05, 1, 0)
  
  
  
  # my.comparisons.clinical<-list( c("fear Learning", "neutral Learning") )
  # clinical.results + stat_compare_means(comparisons = my.comparisons.clinical)
  
  # https://www.datanovia.com/en/blog/ggpubr-how-to-add-p-values-generated-elsewhere-to-a-ggplot/
  
  resultMain %>% 
    select(test,p=Pvalue_bonfCorr) %>% 
    filter(grepl("valence",test,fixed = T)) %>% 
    mutate(
      group1 = case_when(
        # grepl("phase.neutral",test) ~ "neutral Learning",
        #   grepl("phase.emotional",test) ~ "fear Learning"#,
        
        grepl("valence.learning",test) ~ "neutral Learning",
        grepl("valence.memory",test) ~ "neutral Memory"
      ),
      
      group2 = case_when(
        # grepl("phase.neutral",test) ~ "neutral Memory",
        # grepl("phase.emotional",test) ~ "emotional Memory"#,
        
        grepl("valence.learning",test) ~ "fear Learning",
        grepl("valence.memory",test) ~ "emotional Memory"
      ),
      
      phase = c( "Learning", "Memory")
      # valence = c("Neutral", "Emotional", NA, NA)
    ) %>% group_by(phase)-> clinical.posthoc.valence
  
  
  # clinical.posthoc.phase$y.position <-1
  
  
  
  #str(plot_data)
  # title='test'
  
  
  
  PLOT.clinical <-
    ggplot(plot_data_coded,
           aes(x = test, y = effectsize, fill=valence)) +
    
    ylab("Hedge's G (CI)") + # could also be "Standardized mean difference"
    
    xlab("") +
    
    # ggtitle(title, subtitle = subtitle) +
    
    # facet_wrap(.~ factor(phase, levels =c("Learning", "Memory", "Extinction")), scales='free_x', strip.position = "bottom" )+
    
    facet_grid (.~ factor(phase, levels =c("Learning", "Memory", "Extinction")),  # width scaled (better for extinction)
                scales = "free_x", space = "free_x", switch = "x" # labels onder
                # je kan de andere factor levels nog toevoegen en dan hier drop =F, bv voor het vergelijkbaar maken met dieren?
    ) +
    
    theme_linedraw() +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5, face="italic")) +
    
    scale_fill_manual(
      values= c( "Neutral" = "steelblue2", # Colours: http://sape.inf.usi.ch/quick-reference/ggplot2/colour
                 "Emotional" = "tomato2")) +
    
    geom_bar(stat = "identity")+
    
    geom_hline(yintercept = 0, size = 1) +
    geom_errorbar(aes(ymin = ci.lb,
                      ymax = ci.ub),
                  width = .3) +
    
    theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
    
    geom_point(data = plot_data_coded[plot_data_coded$sig ==1, ],aes(x=test, y=1), shape = "*", size=10, show.legend = FALSE) +  # to make position dynamic use: y=ci.ub+1.5
    
    # y_sig_position <- 1 #  ifelse(title=='Clinical Data', 1  , 3.3 )
    #  title='Preclinical Data'
    
    
    #      geom_bracket(
    #        xmin = c(1, 2), xmax = c(3, 4),
    #   # xmin = "0.5", xmax = "1",
    #   # inherit.aes = T,
    #   y.position = 30,
    #   label = "t-test, p < 0.05"
  # )
  
  #       geom_bracket(
  #  aes(xmin = group1, xmax = group2, label = signif(p, 2)),
  #  data = clinical.posthoc, y.position = c(32, 35, 38, 30)
  # )
  
  
  # zelfde issue
  
  # code hieronder werkt
  ggpubr::stat_pvalue_manual(
    data.frame(clinical.posthoc.valence), inherit.aes=F,
    # hide.ns = TRUE,
    # step.group.by=factor(phase, levels =c("Learning", "Memory", "Extinction")),
    
    y.position = 0.3, #step.increase = 0.1,
    label = "p = {p}"
  )
  
  out<-list(resultMain,PLOT.clinical)
  
  return(out)
  
}


```

run function & save plots
```{r}
TRACE_clinical_valence_phase(mod.H,"Clinical Data","PTSD patients") ->clinical.results
clinical.results

clinical.results[[2]]



# save
write.csv2(clinical.results[[1]], paste0("results/LearningMemoryPTSD_clinical", date(),".csv"))

ggsave(paste0("results/LearningMemoryPTSD_clinical", date(),".jpg"),
       plot=clinical.results[[2]],
       device="jpg", dpi = 300, height = 4, width = 6, limitsize = T )



```

```{r eval=FALSE, fig.height=40, fig.width=8, include=FALSE}
forest(mod.H, cex = .2)

# clinical %>% filter(yi > 4) %>% View()
# clinical %>% filter(measure.d == "EXT_%CS+/maxCS+Acq_EMG") %>% View()
```


## *Research Question 2: Learning and Memory of stressful and non-stressful information in animal models of PTSD*
```{r eval=FALSE, include=FALSE}
mod.A <- rma.mv(yi, vi,
                random = list(~1 | PMID, ~1 | idPTSD), # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                mods   = ~phase:Valence_Grouped - 1,  # NB only interaction term
                method = "REML",
                slab = preclinical$reference,  # from old codes milou (change for author/year)
                data = preclinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.A)

animal<-TRACE_output(mod.A, title='Preclinical Data', subtitle='animal models for PTSD')
animal

# to save
jpeg(file="results/preclinical.jpeg", height = 2000, width = 1500, res=300)
animal[[2]]
dev.off()
```


```{r eval=FALSE, include=FALSE}
mod.A <- rma.mv(yi, vi,
                random = list(~1 | new.idPTSD , ~1 | PMID), # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                # mods   = ~phase:Valence_Grouped - 1,  # NB only interaction term
                # mods   = ~phase.valence - 1, #NL & M impaired, rest improved
                mods = ~valence:phase-1, # identical resuls as above (so recoded var not needed)
                method = "REML",
                slab = preclinical$reference,  # from old codes milou (change for author/year)
                data = preclinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.A)
```

```{r eval=FALSE, fig.height=80, fig.width=8, include=FALSE}
forest(mod.A, cex = 0.4)
```




## **data presenation**
```{r}
# Show clincal & preclinical data in one figure.
plots<-ggarrange(
  human[[2]]
  #  + ylim(-7.5,3.5)  # If you want y-axis the same for clinical and preclinical
  + rremove("x.text") + rremove("x.axis") + rremove("x.ticks") + rremove("xlab")
  + rremove("y.axis") + rremove("y.ticks"),
  
  animal[[2]]
  # + ylim(-7.5,3.5)   # If you want y-axis the same for clinical and preclinical
  + rremove("x.text") + rremove("x.axis") + rremove("x.ticks") + rremove("xlab")
  + rremove("ylab") + rremove("y.axis") + rremove("y.ticks"),
  align = "v",
  legend="bottom",
  common.legend = T)

plots
```

## **safe results**
```{r}
# Save figure to jpeg.x
#ggsave(paste0("LearningMemoryPTSD_TRACE", date(),".jpg"), device="jpg", dpi = 500, height = 4, width = 6, limitsize = T )
ggsave(paste0("results/LearningMemoryPTSD_TRACE_NOinfluentials", date(),".jpg"), device="jpg", dpi = 300, height = 4, width = 6, limitsize = T )
#ggsave(paste0("LearningMemoryPTSD_TRACE_yshared", date(),".jpg"), device="jpg", dpi = 500, height = 4, width = 6, limitsize = T )
# ppt standard 4:3
```



# Sensitivity analysis

## study quality

### Clinical
```{r}
mod.H <- rma.mv(yi, vi,
                random = list(~1 | PMID, ~1 | idPTSD),  # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                mods   = ~phase:Valence_Grouped - 1,
                method = "REML",
                slab = clinical$reference,  # from old codes milou (change for author/year)
                data = clinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.H)
```

### Preclinical
```{r}
mod.A <- rma.mv(yi, vi,
                random = list(~1 | PMID, ~1 | idPTSD), # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                mods   = ~phase:Valence_Grouped - 1,  # NB only interaction term
                method = "REML",
                slab = preclinical$reference,  # from old codes milou (change for author/year)
                data = preclinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.A)
```



## Influential cases
phase x valence meta-regression

without cases that were identified as influential &outlier -> for sensitivity analysis


### clinical
```{r}
#clinical.inf<-influentials_valence_phase(clinical)
#saveRDS(clinical.inf, "processed_data/influentials.clinical.rds")
readRDS("processed_data/influentials.clinical.rds")->clinical.inf

# potential outlier and influential cases
clinical.inf[which(clinical.inf$outInf == 1),] %>% nrow()# 15 comparisons
clinical.inf[which(clinical.inf$outInf == 1),]%>% distinct(PMID) %>% nrow() # 7 papers

# # potential outliers
# clinical.inf[which(clinical.inf$potOut == 1),] %>% nrow()# 15 comparision 
# clinical.inf[which(clinical.inf$potOut == 1),]%>% distinct(PMID) %>% nrow()

# remove outliers
##  influential (Viechtbauer & Cheung) 
clinical.inf %>%
  filter(outInf != 1) %>%
  droplevels() -> clinical.noinfout
```


```{r}
mod.H.noinf <- rma.mv(yi, vi,
                      random = list(~1 | PMID, ~1 | idPTSD),  # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                      mods   = ~phase:Valence_Grouped - 1,
                      method = "REML",
                      slab = clinical.noinfout$reference,  # from old codes milou (change for author/year)
                      data = clinical.noinfout) # Similar effects with dat2 (trauma learning excluded)

summary(mod.H.noinf)

```


### preclinical
```{r}
source("r/influentials_valence_phase.r")
#preclinical.inf<-influentials_valence_phase(preclinical)
#saveRDS(preclinical.inf, "processed_data/influentials.preclinical.rds")
readRDS("processed_data/influentials.preclinical.rds")->preclinical.inf

# potential outlier and influential cases
preclinical.inf[which(preclinical.inf$outInf == 1),] %>% nrow() # 11 comparisons
preclinical.inf[which(preclinical.inf$outInf == 1),] %>% distinct(PMID) %>% nrow() # 4 papers

# preclinical.inf %>% filter(outInf == 1 & potOut==1) %>% nrow() # 11 comparisons
# preclinical.inf %>% filter(outInf == 1 & potOut==1) %>% distinct(PMID) %>% nrow() # 4 papers

# # potential outliers
# preclinical.inf[which(preclinical.inf$potOut == 1),] %>% nrow() # 28 comparisons
# preclinical.inf[which(preclinical.inf$potOut == 1),] %>% distinct(PMID) %>% nrow() # 14 papers
# preclinical.inf %>% filter(potOut!=1) #->data.sens

# remove outliers
##  influential (Viechtbauer & Cheung) 
# preclinical.inf %>%
#  filter(outInf != 1) %>%
# droplevels() -> preclinical.noinf # n=4 papers (11 comparison) excluded animal 

preclinical.inf %>%
  filter(outInf != 1) %>%  # potential outliers AND influential
  # filter(potOut!=1) %>%
  droplevels() -> preclinical.noinfnoout
```

```{r}
mod.A.noinf <- rma.mv(yi, vi,
                      random = list(~1 | PMID, ~1 | idPTSD), # valeria had each.. ik heb in oic meta PMID.. results ong same maar beetje anders -> volgens mij is PMID de bedoeling
                      mods   = ~phase:Valence_Grouped - 1,  # NB only interaction term
                      method = "REML",
                      slab = preclinical.noinfnoout$reference,  # from old codes milou (change for author/year)
                      data = preclinical.noinfnoout) # Similar effects with dat2 (trauma learning excluded)
summary(mod.A.noinf)
```




