---
title: "Theory-driven meta-analysis TRACE"
author: "Milou Sep"
date: "4/15/2021"
output: html_document
---

## Analysis script for TRACE analyses (based on analyses script Valeria (meta behavior))
# Code largely based on // adapted from Bonapersona, V. (2019, May 20). The behavioral phenotype of early life adversity: a 3-level meta-analysis of rodent studies. Retrieved from osf.io/ra947


# Environment Preparation
```{r setup, include=FALSE}
rm(list = ls()) #clean environment
# libraries
library(dplyr) #general
library(ggplot2) #for graphs
library(metafor) #for meta-analysis
library(ggpubr) # To show multiple plots in 1 figure
library(flextable) # to create tables
library(officer)# to export tables to word
```

# import dataset (already processed with datasetPreparation)
```{r}
# data<-readRDS("data.RData") # Output from "prepare data.script". # NB trauma learning excluded
data<-readRDS("processed_data/TRACEprepared.RData")
```

# filter data
```{r}
# names(data)

#' Variable / level exclusion (see notes data prep file) 
#' NB Learning & memory of "Trauma" information are never measured in human (with behavioral tasks), therefor not an 'fair' comparison between animal & human..
#' Consider exclusion in 'analysis script'
 # data <- data %>% filter(valence != "T")%>% droplevels() ## Use as 'sensitivity check?'

#' NB extinction data is not available for all groups. Besides it is an specific for of fear learning..
#' Consider exclusion in 'analysis script'
#' 
 # data<- data %>% filter(phase != "E")%>% droplevels()

 
 # filtering for comparisons:
 
 # A= non-exposed vs trauma-exposed PTSD (human); B=non-exposed vs trauma exposed no PTSD (human); C=trauma-exposed (noPTSD) vs trauma-exposed PTSD (human); 
 # D=non-exposed vs trauma-exposed (no PTSD checked) (animal); E=non-exposed vs trauma-exposed PTSD (animal); F=trauma-exposed (no ptsd) vs trauma-exposed PTSD (animal)

 #data <- data %>% filter(comparison %in% c("A","E"))%>% droplevels()
 
 # data <- data %>% filter(comparison %in% c("B","D"))%>% droplevels()
 
 # data <- data %>% filter(comparison %in% c("C","F"))%>% droplevels()
```

# inspect data
```{r}
#' Inspect the data
#+ include =F
data %>% filter(subject.cat == "Animal", Valence_Grouped == "stress") %>% select(reference, measureID, phase, recode)
data %>% filter(subject.cat == "Animal", Valence_Grouped == "neutral") %>% select(reference, measureID, phase, recode, yi)

data %>% filter(subject.cat == "Human", Valence_Grouped == "stress") %>% select(reference, measureID, phase, recode)
data %>% filter(subject.cat == "Human", Valence_Grouped == "neutral") %>% select(reference, measureID, phase, recode)

```

# Descriptives

## **papers included in the analysis**
```{r}

data %>% 
  #group_by(Valence_Grouped, subject, as.factor(task_d)) %>% 
  summarize( length(unique(PMID))) #%>% write.csv2("results/unique.papers.csv") 

data %>% 
  group_by( subject.cat) %>% 
  summarize( length(unique(PMID))) #%>% write.csv2("results/unique.papers.by.subject.csv")
```

## **comparisons included in the analysis**
```{r}

data %>% 
  #group_by(Valence_Grouped, subject, as.factor(task_d)) %>% 
  summarize( length(unique(each))) #%>% write.csv2("results/unique.comparisons.csv") 

data %>% 
  group_by( subject.cat) %>% 
  summarize( length(unique(each)))# %>% write.csv2("results/unique.comparisons.by.subject.csv")
```

## **Show Trauma & PTSD 'types' that are present in animals and humans**
```{r}

# # Recode ptsd variable codes. (for poster CNS2019), can later be adusted in datafile.
# data$ptsd[stringr::str_detect(as.character(data$ptsd.type), "SPS")] <- 'SPS'
# data$ptsd[stringr::str_detect(as.character(data$ptsd.type), "Deployment")] <- 'Deployment'     
# data$ptsd[stringr::str_detect(as.character(data$ptsd.type), "WarRelated")] <- 'Deployment'  
# 
# data$ptsd[stringr::str_detect(as.character(data$ptsd.type), "of PSS?")] <- 'PSS'  
# data$ptsd[stringr::str_detect(as.character(data$ptsd.type), "UWT")] <- 'UT'  
# unique(data$ptsd.type)
# data %>% droplevels() ->data

data %>% 
  group_by(subject.cat, ptsd.type) %>% 
  summarize( length(unique(each))) %>% 
  arrange(desc(subject.cat)) %>% 
  flextable() %>%
  # change header names
  set_header_labels( ptsd.type = "Trauma", 
                     'length(unique(each))'="comparisons") -> TRACEtrauma
TRACEtrauma
# Save to word
doc <- read_docx()
doc <- body_add_flextable(doc, value = TRACEtrauma, align="center")
print(doc, target = paste0("results/TRACEtrauma", date(),".docx"))
```

## **Show tasks that were used to measure stressful & non-stressful learning & memory in animals and humans**
```{r}
data %>% 
  group_by(Valence_Grouped, subject.cat, as.factor(task.d)) %>% 
  summarize( length(unique(each))) %>% # comparisons
 # summarize(length(unique(id)), length(unique(each))) %>% # papers & comparisons
  select(subject.cat, Valence_Grouped, everything())  %>% # NB everything() to leave the order of the other colums unchanged.
  arrange(desc(subject.cat), Valence_Grouped) %>% 
  flextable() %>%  color(i = ~ Valence_Grouped == 'stress', color="red")      %>%

  # change header names
set_header_labels( Valence_Grouped = "valence", 
                   "as.factor(task.d)" = 'task',
                #   'length(unique(id))'="papers",
                   'length(unique(each))'="comparisons") -> TRACEmeasures
TRACEmeasures
# Save to word
doc <- read_docx()
doc <- body_add_flextable(doc, value = TRACEmeasures, align="center")
print(doc, target = paste0("results/TraceMeasures", date(),".docx"))
```

## **show the amount of papers, comparisions and subjects in each category**
```{r}
data %>% 
  group_by(subject.cat, Valence_Grouped, phase) %>% 
 #  distinct(id_combination, .keep_all=T)  %>% 
 # distinct(idExp, .keep_all=T)  %>% 
  #  distinct(idControl, .keep_all=T)  %>% 
  summarize(papers=length(unique(PMID)), comparisons=length(unique(each)), `total n PTSD` = sum(nPTSD), `total n HC` = sum(nHC))  %>% 
  arrange(desc(subject.cat), Valence_Grouped) %>% # nb desc() for descending order
  
  flextable() %>%  
  set_formatter_type(fmt_double="%.00f") %>% # change to no decimals 
  # theme_vanilla() %>%
   # autofit() %>%
  
  # Conditional style change in flextable
 # bold( i = ~ Valence_Grouped == 'stress', j = ~ subject) %>%   # i = row, j = colum
 # italic( i = ~ subject == 'Animal') %>%   # i = row, j = colum
  color(i = ~ Valence_Grouped == 'stress', 
        # j = ~ Petal.Width + Species, 
        color="red")  %>%
  # change header names
  set_header_labels( Valence_Grouped = "valence", 
                     'length(unique(PMID))'="papers",
                     'length(unique(each))'="comparisons",
                     'sum(nPTSD)'="nPTSD",
                     'sum(nHC)'="nHC") -> TRACEsamples

TRACEsamples

# Save to word
doc <- read_docx()
doc <- body_add_flextable(doc, value = TRACEsamples, align="center")
print(doc, target = paste0("results/TraceSample", date(),".docx"))

```

## **Split clinical and preclinical data**
 Model -------------------------------------------------------------------
 In explore_data script frequency of obervations in groups checked.. for now descided to analyse clinical & preclinical data separatly 

```{r}
# Clinical data 
data %>% filter(subject.cat =="Human") %>% droplevels() ->clinical
# Preclinical data 
data %>% filter(subject.cat =="Animal") %>% droplevels() ->preclinical

```

## **influential cases**
```{r}
# check influentials phase * valence analysis ------------------------------------------------------
source("r/influentials_valence_phase.r")
preclinical<-influentials_valence_phase(preclinical)
preclinical[which(preclinical$outInf == 1),]

# remove outliers
##  influential (Viechtbauer & Cheung) 
preclinical %>%
 filter(outInf != 1) %>%
droplevels() -> preclinical # n=4 datapoints excluded animal 


clinical<-influentials_valence_phase(clinical)
clinical[which(clinical$outInf == 1),] # n=4 datapoints excluded human 

# remove outliers
##  influential (Viechtbauer & Cheung) 
clinical %>%
  filter(outInf != 1) %>%
  droplevels() -> clinical

# 8.4. no influentials?
```

# **multilevel models**
```{r}

# Analyses + Plot:
source("r/model_valence_phase.r")
```

## *Research Question 1: Learning and Memory of stressful and non-stressful information in PTSD patients*
```{r}

mod.H <- rma.mv(yi, vi,
                random = list(~1 | each, ~1 | idPTSD),
                #mods = ~phase -1,
                 mods   = ~phase:Valence_Grouped - 1,
                method = "REML",
                slab = clinical$reference,  # from old codes milou (change for author/year)
                data = clinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.H)



human<-TRACE_output(mod.H, title='Clinical Data', subtitle='PTSD patients' )
human

# to save
jpeg(file="results/clinical.jpeg", height = 2000, width = 1500, res=300)
human[[2]]
dev.off()
```

## *Research Question 2: Learning and Memory of stressful and non-stressful information in animal models of PTSD*
```{r}
mod.A <- rma.mv(yi, vi,
                random = list(~1 | each, ~1 | idPTSD),
               # mods = ~ phase -1,
                mods   = ~phase:Valence_Grouped - 1,  # NB only interaction term
                method = "REML",
                slab = preclinical$reference,  # from old codes milou (change for author/year)
                data = preclinical) # Similar effects with dat2 (trauma learning excluded)
summary(mod.A)

animal<-TRACE_output(mod.A, title='Preclinical Data', subtitle='animal models for PTSD')
animal

# to save
jpeg(file="results/preclinical.jpeg", height = 2000, width = 1500, res=300)
animal[[2]]
dev.off()
```

## **data presenation**
```{r}
# Show clincal & preclinical data in one figure.
plots<-ggarrange(
  human[[2]]
#  + ylim(-7.5,3.5)  # If you want y-axis the same for clinical and preclinical
  + rremove("x.text") + rremove("x.axis") + rremove("x.ticks") + rremove("xlab")
 + rremove("y.axis") + rremove("y.ticks"),
 
  animal[[2]]
# + ylim(-7.5,3.5)   # If you want y-axis the same for clinical and preclinical
 + rremove("x.text") + rremove("x.axis") + rremove("x.ticks") + rremove("xlab")
 + rremove("ylab") + rremove("y.axis") + rremove("y.ticks"),
  align = "v",
  legend="bottom",
  common.legend = T)

plots
```

## **safe results**
```{r}

# Save figure to jpeg.x
#ggsave(paste0("LearningMemoryPTSD_TRACE", date(),".jpg"), device="jpg", dpi = 500, height = 4, width = 6, limitsize = T )

ggsave(paste0("results/LearningMemoryPTSD_TRACE_NOinfluentials", date(),".jpg"), device="jpg", dpi = 300, height = 4, width = 6, limitsize = T )

#ggsave(paste0("LearningMemoryPTSD_TRACE_yshared", date(),".jpg"), device="jpg", dpi = 500, height = 4, width = 6, limitsize = T )
# ppt standard 4:3
```

