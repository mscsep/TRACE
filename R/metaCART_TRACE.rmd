---
title: "meta-CART TRACE"
author: "Milou Sep"
date: "4/9/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
rm(list = ls()) #clean environment

library(dplyr) #general
library(metacart)
```


```{r data, include=FALSE}
data<-readRDS("processed_data/TRACEprepared.RData")
# str(data)
data %>% select(subject, nPTSD, nHC,
                sex.PTSD, sex.HC, 
                
                control.type, 
                
                ptsd.type2, 
                population2,
                measure2, 
                
                time.pseudo,
                
                rhythm,
                comparison,
                new.idPTSD, new.idHC,
                
                age.PTSD.cat,
                age.HC.cat,
                
                subject.cat,
                
                reference,
                
                type, phase, valence, cuectx, id_combination,
                
                yi, vi, each, RoB_score
                
                ) %>% droplevels()->data1
```

# fix missing values

```{r}
# are there missing values?
is.na(data1) %>% any()

# are there variables with > 1/3 missing?
which(colSums(is.na(data1)) > (1/3)*nrow(data1)) -> too.much.missing
too.much.missing # no values with 1/3 missing

# check variable types
str(data1) # all correct

#check missing values
summary(data1) # in sex and time pseudo

factors.to.fix <- c("sex.PTSD", "sex.HC")
numeric.to.fix <- c("time.pseudo")

for (i in c(1:length(numeric.to.fix))) {
  # i=1
  numeric.to.fix[[i]] -> varname
  data1[is.na(data1[,varname]),varname] <- median(unlist(data1[,varname]), na.rm = T)
}

#categorical missing: substitute with most common category  {from mAP}
categorical_mode <- function(x){
  names(table(x))[which.max(table(x))]
}


for (i in c(1:length(factors.to.fix))) {
  # i=1
  factors.to.fix[[i]] -> varname
  data1[is.na(data1[,varname]),varname] <- categorical_mode(unlist(data1[,varname]))
}

#any missing values left?
summary(data1)
any(is.na(data1)) # no
```

# tree-model: metaCART
- strength of the package metacart is that it can easily
explore the interaction effects among multiple moderators
using an interpretable tree model.
- multi-categorical variables, it creates automatically the contrasts
between (combinations of) categories that account for the
highest amount of heterogeneity.

from: 1. Li X, Dusseldorp E, Su X, Meulman JJ. Multiple moderator meta-analysis using the R-package Meta-CART. Behav Res Methods [Internet]. 2020;52(6):2657â€“73. Available from: http://dx.doi.org/10.3758/s13428-020-01360-0

- RE model
- c=0.5
- first fit without lookahead -> then recommended to use lookahead = T (especially in REmrt)

idee-> misschien komt warning bij lookahead T door missing values in data?
(check functie code in evernote)  # met alleen complete cases oon geen moderators...

```{r metaCART clinical}
data1 %>% 
  filter(subject.cat == "Human") %>% 
  # filter(comparison != "B") %>% 
           droplevels() ->clinical
 str(clinical)

# Inclusion sex.PTSD sufficient?
# clinical %>% filter(clinical$sex.PTSD != clinical$sex.HC) # one paper different HF and M .. indeed one group only male (trauma exposed PTSD), others UNexp HC and ptsd (M &F)

set.seed(38923)
REmrt(yi ~ subject + 
        nPTSD +
        sex.PTSD + #sex.HC +
        control.type +
        # rhythm + # only 1 level
         ptsd.type2 +
        population2 +

        measure2 + # newest

        # comparison +

        age.PTSD.cat +
           #age.HC.cat +
          time.pseudo +
          type +
        phase + valence +
         # Valence_Grouped +
        cuectx
      ,
      vi = vi, data = clinical, 
      c=0.5,  # als dit 0 is wel moderators.. bij 0.5 geen.. (en bij 1 dan logischer wijs ook niet) -> correctie voor type I error (p<0.05)
      # cp=0.1,
      maxL=15,
      xval=10, # bij c=0.5 en xval= 15 no moderator detected. bij 20 ook niet... bij 10 wel
      lookahead = T  # warning kwam door lookahead true, if T no tree detected
      )->REtree.C

```

inspect warnings
```{r}
REtree.C$initial.tree  # eerste split is NA
```


```{r }
summary(REtree.C)
```


```{r }
plot(REtree.C)
```


```{r}
jpeg(file="results/metaCART.clinical.jpeg", height = 2000, width = 1500, res=300, pointsize = 12)
plot(REtree.C)
dev.off()
```


```{r metaCART preclinical}
data1 %>% filter(subject.cat == "Animal") %>% droplevels() ->preclinical

set.seed(38923)
REmrt(yi ~ subject + 
        nPTSD +
        sex.PTSD + #sex.HC +
        control.type + 
        rhythm +
         ptsd.type2 + 
        population2 +
        
        measure2+ # newest
        
        comparison + 
          
        age.PTSD.cat + 
           #age.HC.cat +
          time.pseudo +
          type + 
        phase + valence + 
         # Valence_Grouped +
        cuectx,
      vi = vi, data = preclinical, 
      c=0.5,  # als dit 0 is wel moderators.. bij 0.5 geen.. (en bij 1 dan logischer wijs ook niet) -> correctie voor type I error (p<0.05)
      maxL=15,
      xval=10,
      lookahead = T  # warnings due to lookahead true  [In if (class(tempQ) == "list") { ... : the condition has length > 1 and only the first element will be used]
      )->REtree.P
```

NB 14.4.21 identical results for lookahead is T or F


inspect warnings
```{r}
REtree.P$initial.tree  # eerste split is NA
```



```{r }
summary(REtree.P)
```


```{r }
plot(REtree.P)
```


```{r}
jpeg(file="results/metaCART.preclinical.lookahead.jpeg", height = 3000, width = 3000, res=300, pointsize = 12)
plot(REtree.P)
dev.off()
```



```{r}
# new.data<-data.frame( ) # create 1 row with values van de variableen waarvor je wil weten wat het effect is.
# predict(REtree.P)
```


# random forest (= multiple trees)

```{r metaforest}

# data %>% select(subject, nPTSD, nHC,
#                 sex.PTSD, sex.HC, 
#                 
#                 control.type, 
#                 
#                 ptsd.type2, 
#                 population2,
#                 measure2, 
#                 
#                 time.pseudo,
#                 
#                 rhythm,
#                 comparison,
#                 new.idPTSD, new.idHC,
#                 
#                 age.PTSD.cat,
#                 age.HC.cat,
#                 
#                 subject.cat,
#                 
#                 reference,
#                 
#                 type, phase, valence, cuectx, id_combination,
#                 
#                 yi, vi, each, RoB_score
#                 
#                 ) %>% droplevels()->data1

clinical %>% select(subject, nPTSD, nHC,
                sex.PTSD, sex.HC, 
                
                control.type, 
                
                ptsd.type2, 
                population2,
                measure2, 
                
                time.pseudo,
                
                rhythm,
                comparison,
                new.idPTSD, #new.idHC,
                
                age.PTSD.cat,
                age.HC.cat,
                
                # subject.cat,
                
              #  reference,
                
                type, phase, valence, cuectx,# id_combination,
                
                yi, vi, #each, 
              RoB_score
                
                ) %>% droplevels()->clinicalForest
  




library(caret)
library(metaforest)

set.seed(94372) #set seeds to a random number
ModelInfo_mf()$notes # method from metaforest

# Set up k-fold grouped CV
fit_control <- trainControl(method = "cv", number = 5, index = groupKFold(clinicalForest$new.idPTSD, k = 5)) # warning with 10-fold crossvalidation "Warning message: In nominalTrainWorkflow(x = x, y = y, wts = weights, info = trainInfo,  :There were missing values in resampled performance measures."

# Set up a custom tuning grid for the three tuning parameters of MetaForest
rf_grid <- expand.grid(whichweights = c("random", "fixed", "unif"),
                       mtry = c(2, 4, 6),
                       min.node.size = c(2, 4, 6))


set.seed(94372)
# Train the model
cv.mf.cluster <- train(y = clinicalForest$yi, x = clinicalForest[names(clinicalForest) !="yi"], #from x remove yi
                       study = "new.idPTSD", 
                       method = ModelInfo_mf(), #= method from metaforest. https://rdrr.io/cran/metaforest/man/MetaForest.html
                       trControl = fit_control,
                       tuneGrid = rf_grid,
                         num.trees = 700, # a bit more than default 500 (for better convergence)
                       data=clinicalForest)

# saveRDS(cv.mf.cluster,file="processed_data/fitted.MetaForest.RDS")

# {jpeg(file="results/metaforest_convergencePlot.jpeg", height = 3000, width = 3000, res=500) # Higher quality output
plot(cv.mf.cluster$finalModel) 
# dev.off()}

cv.mf.cluster$finalModel



VarImpPlot(cv.mf.cluster$finalModel)

```

