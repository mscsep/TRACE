---
title: "meta-CART TRACE"
author: "Milou Sep"
date: "4/9/2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

# prepare environment
```{r setup, include=FALSE}
rm(list = ls()) #clean environment

library(dplyr) #general
library(metacart)

library(caret)
library(metaforest)
```

# load and select data

```{r data, include=FALSE}
data<-readRDS("processed_data/TRACEprepared.RData")

data %>% select(subject, #nPTSD, nHC,
                sex.PTSD, #sex.HC,
                control.type,
                ptsd.type2,
                population2,
                measure2,
                time.pseudo,
                rhythm,
                comparison,
                new.idPTSD, #new.idHC,
                age.PTSD.cat, #age.HC.cat,
                subject.cat,
                # reference,
                type, phase, valence, cuectx, #id_combination,
                yi, vi#, #each, RoB_score
) %>% droplevels()-> data.explore #%>%data.frame()
```

# fix missing values

are there missing values?
```{r}
is.na(data.explore) %>% any()
```

are there variables with > 1/3 missing?
```{r}
which(colSums(is.na(data.explore)) > (1/3)*nrow(data.explore)) # no values with 1/3 missing
```

check variable types
```{r}
str(data.explore) # all correct
```


```{r}
#check missing values
summary(data.frame(data.explore)) # in sex and time pseudo
```


```{r}
factors.to.fix <- c("sex.PTSD"#, "sex.HC"
)
numeric.to.fix <- c("time.pseudo")

for (i in c(1:length(numeric.to.fix))) {
  # i=1
  numeric.to.fix[[i]] -> varname
  data.explore[is.na(data.explore[,varname]),varname] <- median(unlist(data.explore[,varname]), na.rm = T)
}

#categorical missing: substitute with most common category  {from mAP}
categorical_mode <- function(x){
  names(table(x))[which.max(table(x))]
}


for (i in c(1:length(factors.to.fix))) {
  # i=1
  factors.to.fix[[i]] -> varname
  data.explore[is.na(data.explore[,varname]),varname] <- categorical_mode(unlist(data.explore[,varname]))
}

#any missing values left?
summary(data.frame(data.explore))
```


```{r}
any(is.na(data.explore)) # no
```

## split data 

Comparison B [B=non-exposed vs trauma exposed no PTSD (human)] is excluded from clinical data, as the experimental group does not contain PTSD patients. Note, this comparison is used in the sensitivity analysis of the theorydriven analysis. The comparison variable is also excluded from the human dataset, as the difference between comparison A [A= non-exposed vs trauma-exposed PTSD (human)] and comparison C [C=trauma-exposed (noPTSD) vs trauma-exposed PTSD (human)] is captured by the 'control type' variable (with levels unexposed, shamexposed, trauma exposed).

[A= non-exposed vs trauma-exposed PTSD (human); B=non-exposed vs trauma exposed no PTSD (human); C=trauma-exposed (noPTSD) vs trauma-exposed PTSD (human); D=non-exposed vs trauma-exposed (no PTSD checked) (animal); E=non-exposed vs trauma-exposed PTSD (animal); F=trauma-exposed (no ptsd) vs trauma-exposed PTSD (animal)]

```{r}
data.explore %>% 
  filter(subject.cat == "Human") %>% 
  filter(comparison != "B") %>% 
  select(-c(rhythm, subject.cat, comparison)) %>%
  droplevels() ->clinical
str(clinical)
```

Comparison is included in the preclinical dataset, as most datapoints come from comparison D and we want to explore the influence of this experimental variation. 

D=non-exposed vs trauma-exposed (no PTSD checked) (animal); E=non-exposed vs trauma-exposed PTSD (animal); F=trauma-exposed (no ptsd) vs trauma-exposed PTSD (animal)]
```{r}
data.explore %>% 
  filter(subject.cat == "Animal") %>% 
  select(-subject.cat) %>%
  droplevels() ->preclinical
str(preclinical)
```


# metaCART: tree-model
- strength of the package metacart is that it can easily
explore the interaction effects among multiple moderators
using an interpretable tree model.
- multi-categorical variables, it creates automatically the contrasts
between (combinations of) categories that account for the
highest amount of heterogeneity.

from: 1. Li X, Dusseldorp E, Su X, Meulman JJ. Multiple moderator meta-analysis using the R-package Meta-CART. Behav Res Methods [Internet]. 2020;52(6):2657â€“73. Available from: http://dx.doi.org/10.3758/s13428-020-01360-0

- RE model
- c=0.5
- first fit without lookahead -> then recommended to use lookahead = T (especially in REmrt)

- maxL 10? geen advies, zelfde als hier: [1. Li X, Dusseldorp E, Su X, Meulman JJ. Multiple moderator meta-analysis using the R-package Meta-CART. Behav Res Methods. 2020;52(6):2657-2673. doi:10.3758/s13428-020-01360-0]
)
## Clinical
```{r metaCART clinical, eval=FALSE, warning=FALSE, include=FALSE}
colnames(clinical)[which(!colnames(clinical) %in% c("yi", "vi", "new.idPTSD"))] ->c.vars
paste("yi ~", paste(c.vars,collapse="+")) ->c.vars.form

set.seed(38923)
REmrt(formula(c.vars.form),
      vi = vi, data = clinical, 
      c=0.5,  # als dit 0 is wel moderators.. bij 0.5 geen.. (en bij 1 dan logischer wijs ook niet) -> correctie voor type I error (p<0.05)
      # cp=0.1,
      maxL=10,
      xval=10, # bij c=0.5 en xval= 15 no moderator detected. bij 20 ook niet... bij 10 wel
      lookahead = T  # warning kwam door lookahead true, if T no tree detected
)->REtree.C

saveRDS(REtree.C, "processed_data/REtree.C.rds")
```

```{r}
readRDS( "processed_data/REtree.C.rds")->REtree.C
```

inspect warnings
```{r}
REtree.C$initial.tree  
```
NB eerste split is NA  (ongeacht lookahead true or false), is hier ook: 1. Li X, Dusseldorp E, Su X, Meulman JJ. Multiple moderator meta-analysis using the R-package Meta-CART. Behav Res Methods. 2020;52(6):2657-2673. doi:10.3758/s13428-020-01360-0

```{r }
summary(REtree.C)
```

```{r }
plot(REtree.C)
```

```{r}
jpeg(file="results/metaCART.clinical.lookaheadT.jpeg", height =3000, width = 3000, res=300, pointsize = 12)
plot(REtree.C)
dev.off()
```

## Preclinical
```{r metaCART preclinical, eval=FALSE, warning=FALSE, include=FALSE}
colnames(preclinical)[which(!colnames(preclinical) %in% c("yi", "vi", "new.idPTSD"))] ->p.vars
paste("yi ~", paste(p.vars,collapse="+")) ->p.vars.form

set.seed(38923)
REmrt(formula(p.vars.form),
      vi = vi, data = preclinical, 
      c=0.5,  # als dit 0 is wel moderators.. bij 0.5 geen.. (en bij 1 dan logischer wijs ook niet) -> correctie voor type I error (p<0.05)
      # cp=0.1,
      maxL=10,
      xval=10, # bij c=0.5 en xval= 15 no moderator detected. bij 20 ook niet... bij 10 wel
      lookahead = T # warning kwam door lookahead true, if T no tree detected
)->REtree.P

saveRDS(REtree.P, "processed_data/REtree.P.rds")
```

```{r}
readRDS("processed_data/REtree.P.rds")->REtree.P
```



inspect warnings
```{r}
REtree.P$initial.tree  # eerste split is NA
```

```{r }
summary(REtree.P)
```

```{r }
plot(REtree.P)
```

```{r}
jpeg(file="results/metaCART.preclinical.lookaheadT.jpeg", height = 3000, width = 3000, res=300, pointsize = 12)
plot(REtree.P)
dev.off()
```

```{r}
# new.data<-data.frame( ) # create 1 row with values van de variableen waarvor je wil weten wat het effect is.
# predict(REtree.P)
```


# metaForest: random forest (= multiple trees)

```{r}
ModelInfo_mf()$notes # method from metaforest
```

## Clinical

```{r eval=FALSE, include=FALSE}
# set.seed(94372) #set seeds to a random number
 set.seed(12345)
# Set up k-fold grouped CV
fit_control.clinical <- trainControl(method = "cv", number = 10, index = groupKFold(clinical$new.idPTSD, k = 10))

# Set up a custom tuning grid for the three tuning parameters of MetaForest
rf_grid <- expand.grid(whichweights = c("random", "fixed", "unif"),
                       mtry = c(2, 4, 6),
                       min.node.size = c(2, 4, 6))

# set.seed(94372)
 set.seed(12345)
# Train the model
cv.mf.cluster.clinical <- train(y = clinical$yi, x = clinical[names(clinical) !="yi"], #from x remove yi
                                study = "new.idPTSD", 
                                method = ModelInfo_mf(), #= method from metaforest. https://rdrr.io/cran/metaforest/man/MetaForest.html
                                trControl = fit_control.clinical,
                                tuneGrid = rf_grid,
                                num.trees = 500, # same var imp & convergencemet 1000 tree
                                data=clinical)

 saveRDS(cv.mf.cluster.clinical,file="processed_data/fitted.clinicalMetaForest.RDS")
```


```{r}
readRDS(file="processed_data/fitted.clinicalMetaForest.RDS")->cv.mf.cluster.clinical
```

### Tuning parameters
```{r}
cv.mf.cluster.clinical
```

```{r}
plot(cv.mf.cluster.clinical) # 
```

### Model convergence
```{r}
{
  jpeg(file="results/metaforest_Clinical_convergence.jpeg", height = 1000, width = 1000,pointsize=8, res=300) # Higher quality output
   # tiff(file="results/metaforest_Clinical_convergence.tiff", height=1000, width=1000, pointsize=8, res=300)
plot(cv.mf.cluster.clinical$finalModel) 
 dev.off()
 }
```

### Model summary
```{r}
summary(cv.mf.cluster.clinical)
```

### R(oob)
https://towardsdatascience.com/what-is-out-of-bag-oob-score-in-random-forest-a7fa23d710
```{r eval=FALSE, include=FALSE}
cv.mf.cluster.clinical$finalModel
```
Note, R(oob) also shown in summary above

### Cross validated R2 with SD
```{r }
cv.mf.cluster.clinical$results[which(cv.mf.cluster.clinical$results$whichweights == "fixed" & 
                                       cv.mf.cluster.clinical$results$mtry == 2 & 
                                       cv.mf.cluster.clinical$results$min.node.size == 6),] #details with the "best" model
```

### Variable importance
```{r}
tiff(file="results/metaforest_Clinical_varImportance.tiff", height=1000, width=1000, pointsize=8, res=300)
VarImpPlot(cv.mf.cluster.clinical$finalModel#, n.var = 4
           )
# +  geom_hline(yintercept=11.5) +
#   annotate(geom="text", x=0.0017, y=12.5, label="Top 50%", color="darkblue")
 dev.off()
```

negative variable importance (in metaforest) ~ just no relation to outcome
http://developmentaldatascience.org/post/29-01-18_metaforest_no_effect/

### PD plots

```{r}
# https://www.rdocumentation.org/packages/metaforest/versions/0.1.3
varImp(cv.mf.cluster.clinical,scale = F) ->imp.scores.clinical


# export variable importance scores (ordered) to csv
imp.clinical <- as.data.frame(imp.scores.clinical$importance)
imp.clinical <- data.frame(overall = imp.clinical$Overall,
                  names   = rownames(imp.clinical))
write.csv2(imp.clinical[order(imp.clinical$overall,decreasing = T),],"results/important_variables_clinical_metaforest.csv")

# select top half most imporant variables
imp.clinical[order(imp.clinical$overall,decreasing = T),] %>%
  filter(overall >0) -> important.vars.clinical
  # slice_head(.,n=nrow(.) / 2) 
 

important.vars.clinical$names ->variable.clinical
variable.clinical

# saveRDS(variable,"processed_data/important_variables.RDS")
```

```{r}

# for (i in 1:length(variable.clinical)) {
# 
#   thisMod <- variable.clinical[i]
#   WeightedScatter(clinical, yi = "yi", vi = "vi", vars = thisMod, summarize = TRUE)
#   ggsave(paste0("results/clinical_metaforest_WeightedScatter_", thisMod, ".tiff"))
# 
#   PartialDependence(cv.mf.cluster.clinical$finalModel, vars = thisMod)
#   ggsave(paste0("results/.clinical_metaforest_partDep_", thisMod, ".tiff"))
# 
#   # a <- 1
# 
# } # Plots saved in your folder
{jpeg(file="results/metaforest_PD_main_clinical.jpeg", height = 1500, width = 5000, res=300) # Higher quality output
PartialDependence(cv.mf.cluster.clinical$finalModel, vars = variable.clinical, #moderator =  "phase",
                  rawdata=F#, pi = .95
                  )
dev.off()}

{jpeg(file="results/metaforest_PD_byPhase_clinical.jpeg", height = 1500, width = 5000, res=300) # Higher quality output
PartialDependence(cv.mf.cluster.clinical$finalModel, vars = variable.clinical, moderator =  "phase",rawdata=F#, pi = .95
                  )
dev.off()}

{jpeg(file="results/metaforest_PD_byValence_clinical.jpeg", height = 1500, width = 5000, res=300) # Higher quality output
PartialDependence(cv.mf.cluster.clinical$finalModel, vars = variable.clinical, moderator =  "valence",rawdata=F#, pi = .95
                  )
dev.off()}

# WeightedScatter(clinical, yi = "yi", vi = "vi", vars = variable.clinical, summarize = TRUE)
```

 interactions from metaCART
```{r}
{jpeg(file="results/metaforest_PD_clinical_metaCARTfollowup.jpeg", height = 1500, width = 6000, res=300) # Higher quality output

PartialDependence(cv.mf.cluster.clinical$finalModel, vars=c("subject", "type"), moderator = "age.PTSD.cat")
# + 
#                   legend.position = c(4,2)+
#                   legend.justification=c("left, rigth")   # werkt niet.. in oic meta aanpassing op schript gemaakt
dev.off()}



# ggarrange(
#   # PLOT.clinical
#   # #  + ylim(-7.5,3.5)  # If you want y-axis the same for clinical and preclinical
#   # # + rremove("x.text") 
#   # + rremove("x.axis") + rremove("x.ticks") + rremove("xlab")
#   # + rremove("y.axis") + rremove("y.ticks"),
#   
#   p,
#   # + ylim(-7.5,3.5)   # If you want y-axis the same for clinical and preclinical
#   # + rremove("x.text") 
#   # + rremove("x.axis") + rremove("x.ticks") + rremove("xlab")
#   # + #rremove("ylab") + 
#     # rremove("y.axis") + rremove("y.ticks"),
#   # ncol =1, nrow=2,
#   # align = "v",
#   legend="bottom",
#   common.legend = T)
```


```{r eval=FALSE, include=FALSE}
PartialDependence(cv.mf.cluster.clinical$finalModel, vars="type", moderator = "age.PTSD.cat") 
```



## Preclinical
```{r eval=FALSE, include=FALSE}
set.seed(94372) #set seeds to a random number
# Set up k-fold grouped CV
fit_control.preclinical <- trainControl(method = "cv", number = 10, index = groupKFold(preclinical$new.idPTSD, k = 10)) # warning with 10-fold crossvalidation "Warning message: In nominalTrainWorkflow(x = x, y = y, wts = weights, info = trainInfo,  :There were missing values in resampled performance measures."

set.seed(94372)
# Train the model
cv.mf.cluster.preclinical <- train(y = preclinical$yi, x = preclinical[names(preclinical) !="yi"], #from x remove yi
                                   study = "new.idPTSD", 
                                   method = ModelInfo_mf(), #= method from metaforest. https://rdrr.io/cran/metaforest/man/MetaForest.html
                                   trControl = fit_control.preclinical,
                                   tuneGrid = rf_grid,
                                    num.trees = 500,
                                   data=preclinical)

saveRDS(cv.mf.cluster.preclinical,file="processed_data/fitted.preclinicalMetaForest.RDS")
```

```{r}
readRDS(file="processed_data/fitted.preclinicalMetaForest.RDS")->cv.mf.cluster.preclinical
```

### Tuning parameters
```{r}
cv.mf.cluster.preclinical
```

```{r}
plot(cv.mf.cluster.preclinical) # 
```

### Model convergence
```{r}
 {
   #jpeg(file="results/metaforest_convergencePlot.jpeg", height = 3000, width = 3000, res=500) # Higher quality output
     jpeg(file="results/metaforest_Preclinical_convergence.jpeg", height = 1000, width = 1000,pointsize=8, res=300) # Higher quality output
 
plot(cv.mf.cluster.preclinical$finalModel) 
 dev.off()}
```

### Model summary
```{r}
summary(cv.mf.cluster.preclinical)
```

### R(oob)
https://towardsdatascience.com/what-is-out-of-bag-oob-score-in-random-forest-a7fa23d710
```{r eval=FALSE, include=FALSE}
cv.mf.cluster.preclinical$finalModel
```
Note, R(oob) also shown in summary above

### Cross validated R2 with SD
```{r }
cv.mf.cluster.preclinical$results[which(cv.mf.cluster.preclinical$results$whichweights == "random" & 
                                          cv.mf.cluster.preclinical$results$mtry == 6 & 
                                          cv.mf.cluster.preclinical$results$min.node.size == 2),] #details with the "best" model
```

### Variable importance
```{r}
tiff(file="results/metaforest_Preclinical_varImportance.tiff", height=1000, width=1000, pointsize=8, res=300)
VarImpPlot(cv.mf.cluster.preclinical$finalModel)
# +  geom_hline(yintercept=11.5) +
#   annotate(geom="text", x=0.0017, y=12.5, label="Top 50%", color="darkblue")
 dev.off()
```


### PD plots
```{r}
# https://www.rdocumentation.org/packages/metaforest/versions/0.1.3
varImp(cv.mf.cluster.preclinical,scale = F) ->imp.scores.preclinical


# export variable importance scores (ordered) to csv
imp.preclinical <- as.data.frame(imp.scores.preclinical$importance)
imp.preclinical <- data.frame(overall = imp.preclinical$Overall,
                  names   = rownames(imp.preclinical))
write.csv2(imp.preclinical[order(imp.preclinical$overall,decreasing = T),],"results/important_variables_preclinical_metaforest.csv")

# select top half most imporant variables
imp.preclinical[order(imp.preclinical$overall,decreasing = T),] %>%
   filter(overall >0) -> important.vars.preclinical
   # slice_head(.,n=nrow(.) / 2) 
 

important.vars.preclinical$names ->variable.preclinical
variable.preclinical

# saveRDS(variable,"processed_data/important_preclinical_variables.RDS")
```

```{r}
# for (i in 1:length(variable.clinical)) {
# 
#   thisMod <- variable.clinical[i]
#   WeightedScatter(clinical, yi = "yi", vi = "vi", vars = thisMod, summarize = TRUE)
#   ggsave(paste0("results/clinical_metaforest_WeightedScatter_", thisMod, ".tiff"))
# 
#   PartialDependence(cv.mf.cluster.clinical$finalModel, vars = thisMod)
#   ggsave(paste0("results/.clinical_metaforest_partDep_", thisMod, ".tiff"))
# 
#   # a <- 1
# 
# } # Plots saved in your folder




# } # Plots saved in your folder
{jpeg(file="results/metaforest_PD_main_preclinical.jpeg", height = 1500, width = 5000, res=300) # Higher quality output
PartialDependence(cv.mf.cluster.preclinical$finalModel, vars = variable.preclinical, #moderator =  "phase",
                  rawdata=F#, pi = .95
                  )
dev.off()}

{jpeg(file="results/metaforest_PD_byPhase_preclinical.jpeg", height = 1500, width = 5000, res=300) # Higher quality output
PartialDependence(cv.mf.cluster.preclinical$finalModel, vars = variable.preclinical, moderator =  "phase",rawdata=F#, pi = .95
                  )
dev.off()}

{jpeg(file="results/metaforest_PD_byValence_preclinical.jpeg", height = 1500, width = 5000, res=300) # Higher quality output
PartialDependence(cv.mf.cluster.preclinical$finalModel, vars = variable.preclinical, moderator =  "valence",rawdata=F#, pi = .95
                  )
dev.off()}

```

 interactions from metaCART
```{r}
{jpeg(file="results/metaforest_PD_preclinical_metaCARTfollowup.jpeg", height = 1500, width = 6000, res=300) # Higher quality output

PartialDependence(cv.mf.cluster.preclinical$finalModel, vars=c("ptsd.type2", "phase"), moderator = "type")
# + 
#                   legend.position = c(4,2)+
#                   legend.justification=c("left, rigth")   # werkt niet.. in oic meta aanpassing op schript gemaakt
dev.off()}



# ggarrange(
#   # PLOT.clinical
#   # #  + ylim(-7.5,3.5)  # If you want y-axis the same for clinical and preclinical
#   # # + rremove("x.text") 
#   # + rremove("x.axis") + rremove("x.ticks") + rremove("xlab")
#   # + rremove("y.axis") + rremove("y.ticks"),
#   
#   p,
#   # + ylim(-7.5,3.5)   # If you want y-axis the same for clinical and preclinical
#   # + rremove("x.text") 
#   # + rremove("x.axis") + rremove("x.ticks") + rremove("xlab")
#   # + #rremove("ylab") + 
#     # rremove("y.axis") + rremove("y.ticks"),
#   # ncol =1, nrow=2,
#   # align = "v",
#   legend="bottom",
#   common.legend = T)
```


```{r eval=FALSE, include=FALSE}
WeightedScatter(preclinical, yi = "yi", vi = "vi", vars = variable.preclinical, summarize = TRUE)
```
